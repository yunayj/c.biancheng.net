<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="renderer" content="webkit" />
<meta name="force-rendering" content="webkit"/>
<meta name="applicable-device" content="pc,mobile" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="format-detection" content="telephone=no" />
<link rel="shortcut icon" href="../favicon.ico" />
<link href="../templets/new/style/common.css" rel="stylesheet" />
<title>Hystrix：Spring Cloud服务熔断与降级组件（非常详细）</title>
<meta name="description" content="在微服务架构中，一个应用往往由多个服务组成，这些服务之间相互依赖，依赖关系错综复杂。 例如一个微服务系统中存在 A、B、C、D、E、F 等多个服务，它们的依赖关系如下图。 图" />
</head>
<body>
<div id="topbar" class="clearfix">
<ul id="product-type" class="left">
<li>
<a href="../c_biancheng_default.html"><span class="iconfont iconfont-home"></span>首页</a>
</li>
<li class="active">
<a href="../sitemap/sitemap_3.html" rel="nofollow"><span class="iconfont iconfont-book"></span>教程</a>
</li>
<li>
<a href="http://vip.biancheng.net/p/vip/show.php" rel="nofollow" target="_blank"><span class="iconfont iconfont-vip"></span>VIP会员</a>
</li>
<li>
<a href="../fudao_biancheng_default.html" rel="nofollow" target="_blank"><span class="iconfont iconfont-fudao"></span>辅导班</a>
</li>
<li>
<a href="../view/niz69i.html" target="_blank"><span class="iconfont iconfont-chip"></span>嵌入式学习路线</a>
</li>
</ul>
</div>
<div id="header" class="clearfix">
<a id="logo" class="left" href="../c_biancheng_default.html">
<img height="26" src="../templets/new/images/logo.png" alt="C语言中文网" />
</a>
<ul id="nav-main" class="hover-none left clearfix">
<li class="wap-yes"><a href="../c_biancheng_default.html">首页</a></li>
<li><a href="../c/c_3.html">C语言教程</a></li>
<li><a href="../cplus/cplus.html">C++教程</a></li>
<li><a href="../python/python.html">Python教程</a></li>
<li><a href="../java/java_3.html">Java教程</a></li>
<li><a href="../linux_tutorial/linux_tutorial.html">Linux入门</a></li>
<li><a href="../sitemap/sitemap_3.html" title="网站地图">更多&gt;&gt;</a></li>
</ul>
<span id="sidebar-toggle" class="toggle-btn" toggle-target="#sidebar">目录 <span class="iconfont"></span></span>
<a href="http://vip.biancheng.net/?from=topbar" class="user-info iconfont iconfont-user hover-none" target="_blank" rel="nofollow" title="用户中心"></a>
</div>
<div id="main" class="clearfix">
<div id="sidebar" class="toggle-target">
<div id="contents">
<dt><span class="iconfont iconfont-list-vertical" aria-hidden="true"></span><a href="springcloud.html">Spring Cloud</a></dt>
<dd>
<span class="channel-num">1</span>
<a href="micro-service.html">微服务是什么</a>
</dd>
<dd>
<span class="channel-num">2</span>
<a href="what-is-cloud.html">Spring Cloud是什么</a>
</dd>
<dd>
<span class="channel-num">3</span>
<a href="eureka.html">Spring Cloud Eureka</a>
</dd>
<dd>
<span class="channel-num">4</span>
<a href="ribbon.html">Spring Cloud Ribbon</a>
</dd>
<dd>
<span class="channel-num">5</span>
<a href="open-feign.html">Spring Cloud OpenFeign</a>
</dd>
<dd>
<span class="channel-num">6</span>
<a href="hystrix.html">Spring Cloud Hystrix</a>
</dd>
<dd>
<span class="channel-num">7</span>
<a href="gateway.html">Spring Cloud Gateway</a>
</dd>
<dd>
<span class="channel-num">8</span>
<a href="config.html">Spring Cloud Config</a>
</dd>
<dd>
<span class="channel-num">9</span>
<a href="what-is-alibaba.html">Spring Cloud Alibaba是什么</a>
</dd>
<dd>
<span class="channel-num">10</span>
<a href="nacos.html">Spring Cloud Alibaba Nacos</a>
</dd>
<dd>
<span class="channel-num">11</span>
<a href="sentinel.html">Spring Cloud Alibaba Sentinel</a>
</dd>
<dd>
<span class="channel-num">12</span>
<a href="seata.html">Spring Cloud Alibaba Seata</a>
</dd>
</div>
</div>
<div id="article-wrap">
<div id="article">
<div class="arc-info">
<span class="position"><span class="iconfont iconfont-home2"></span> <a href="../c_biancheng_default.html">首页</a> &gt; <a href="springcloud.html">Spring Cloud</a></span>
</div>
<div id="ggxc-position-bottom" class="ggxc-box"></div>
<h1>Hystrix：Spring Cloud服务熔断与降级组件（非常详细）</h1>
<div class="pre-next-page clearfix">&nbsp;</div>
<div id="ggxc-arctop-pc-1" class="ggxc-box"></div>
<div id="arc-body"><span style="font-size: 14px; font-weight: normal;">在微服务架构中，一个应用往往由多个服务组成，这些服务之间相互依赖，依赖关系错综复杂。</span><br />
<br />
例如一个微服务系统中存在 A、B、C、D、E、F 等多个服务，它们的依赖关系如下图。<br />
<br />
<div style="text-align: center;">
<img alt="" src="../uploads/allimg/211210/101623H11-0.png" /></div>
<div style="text-align: center;">
图1：服务依赖关系</div>
<br />
通常情况下，一个用户请求往往需要多个服务配合才能完成。如图 1 所示，在所有服务都处于可用状态时，请求 1 需要调用 A、D、E、F 四个服务才能完成，请求 2 需要调用 B、E、D 三个服务才能完成，请求 3 需要调用服务 C、F、E、D 四个服务才能完成。<br />
<br />
当服务 E 发生故障或网络延迟时，会出现以下情况：
<ol>
<li>
即使其他所有服务都可用，由于服务 E 的不可用，那么用户请求 1、2、3 都会处于阻塞状态，等待服务 E 的响应。在高并发的场景下，会导致整个服务器的线程资源在短时间内迅速消耗殆尽。</li>
<li>
所有依赖于服务 E 的其他服务，例如服务 B、D 以及 F 也都会处于线程阻塞状态，等待服务 E 的响应，导致这些服务的不可用。</li>
<li>
所有依赖服务B、D 和 F 的服务，例如服务 A 和服务 C 也会处于线程阻塞状态，以等待服务 D 和服务 F 的响应，导致服务 A 和服务 C 也不可用。</li>
</ol>
<br />
从以上过程可以看出，当微服务系统的一个服务出现故障时，故障会沿着服务的调用链路在系统中疯狂蔓延，最终导致整个微服务系统的瘫痪，这就是&ldquo;雪崩效应&rdquo;。为了防止此类事件的发生，微服务架构引入了&ldquo;熔断器&rdquo;的一系列服务容错和保护机制。
<h2>
熔断器</h2>
熔断器（Circuit Breaker）一词来源物理学中的电路知识，它的作用是当线路出现故障时，迅速切断电源以保护电路的安全。<br />
<br />
在微服务领域，熔断器最早是由 Martin Fowler 在他发表的 《<a href="https://martinfowler.com/bliki/CircuitBreaker.html" target="_blank">Circuit Breake</a>r》一文中提出。与物理学中的熔断器作用相似，微服务架构中的熔断器能够在某个服务发生故障后，向服务调用方返回一个符合预期的、可处理的降级响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常。这样就保证了服务调用方的线程不会被长时间、不必要地占用，避免故障在微服务系统中的蔓延，防止系统雪崩效应的发生。
<h2>
Spring Cloud Hystrix&nbsp;</h2>
Spring Cloud Hystrix 是一款优秀的服务容错与保护组件，也是 Spring Cloud 中最重要的组件之一。<br />
<br />
Spring Cloud Hystrix&nbsp;是基于 Netflix 公司的开源组件 Hystrix 实现的，它提供了熔断器功能，能够有效地阻止分布式微服务系统中出现联动故障，以提高微服务系统的弹性。Spring Cloud Hystrix 具有服务降级、服务熔断、线程隔离、请求缓存、请求合并以及实时故障监控等强大功能。<br />
<blockquote>
<p>
Hystrix [hɪst&#39;rɪks]，中文含义是豪猪，豪猪的背上长满了棘刺，使它拥有了强大的自我保护能力。而 Spring Cloud Hystrix 作为一个服务容错与保护组件，也可以让服务拥有自我保护的能力，因此也有人将其戏称为&ldquo;豪猪哥&rdquo;。</p>
</blockquote>
在微服务系统中，Hystrix 能够帮助我们实现以下目标：<br />
<ul>
<li>
<strong>保护线程资源</strong>：防止单个服务的故障耗尽系统中的所有线程资源。</li>
<li>
<strong>快速失败机制</strong>：当某个服务发生了故障，不让服务调用方一直等待，而是直接返回请求失败。</li>
<li>
<strong>提供降级（FallBack）方案</strong>：在请求失败后，提供一个设计好的降级方案，通常是一个兜底方法，当请求失败后即调用该方法。</li>
<li>
<strong>防止故障扩散</strong>：使用熔断机制，防止故障扩散到其他服务。</li>
<li>
<strong>监控功能</strong>：提供熔断器故障监控组件 Hystrix Dashboard，随时监控熔断器的状态。</li>
</ul>
<h2>
Hystrix 服务降级</h2>
Hystrix 提供了服务降级功能，能够保证当前服务不受其他服务故障的影响，提高服务的健壮性。<br />
<br />
服务降级的使用场景有以下 2 种：
<ul>
<li>
在服务器压力剧增时，根据实际业务情况及流量，对一些不重要、不紧急的服务进行有策略地不处理或简单处理，从而释放服务器资源以保证核心服务正常运作。</li>
<li>
当某些服务不可用时，为了避免长时间等待造成服务卡顿或雪崩效应，而主动执行备用的降级逻辑立刻返回一个友好的提示，以保障主体业务不受影响。</li>
</ul>
<br />
我们可以通过重写 HystrixCommand 的 getFallBack() 方法或 HystrixObservableCommand 的 resumeWithFallback() 方法，使服务支持服务降级。<br />
<br />
Hystrix 服务降级 FallBack 既可以放在服务端进行，也可以放在客户端进行。<br />
<br />
Hystrix 会在以下场景下进行服务降级处理：
<ul>
<li>
程序运行异常</li>
<li>
服务超时</li>
<li>
熔断器处于打开状态</li>
<li>
线程池资源耗尽</li>
</ul>
<h2>
示例1</h2>
下面我们就通过一个案例，分别演示下 Hystrix&nbsp;服务端服务降级和客户端服务降级。
<h4>
服务端服务降级</h4>
1. 在主工程&nbsp;spring-cloud-demo2 下创建一个名为&nbsp;micro-service-cloud-provider-dept-hystrix-8004 的服务提供者，并在其 pom.xml 中添加以下依赖。
<pre class="xml">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;!--父pom--&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;spring-cloud-demo2&lt;/artifactId&gt;
        &lt;groupId&gt;net.biancheng.c&lt;/groupId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;net.biancheng.c&lt;/groupId&gt;
    &lt;artifactId&gt;micro-service-cloud-provider-dept-hystrix-8004&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;micro-service-cloud-provider-dept-hystrix-8004&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!--添加 Spring Boot 的监控模块--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- eureka 客户端--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--hystrix 依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;excludes&gt;
                        &lt;exclude&gt;
                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
                        &lt;/exclude&gt;
                    &lt;/excludes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</pre>
<br />
2. 在类路径（即 /resources 目录）下添加一个配置文件 application.yml，配置内容如下。
<pre class="xml">
spring:
  application:
    name: microServiceCloudProviderDeptHystrix  #微服务名称，对外暴漏的微服务名称，十分重要

server:
  port: 8004
########################################### Spring cloud 自定义服务名称和 ip 地址###############################################
eureka:
  client: #将客户端注册到 eureka 服务列表内
    service-url:
      #defaultZone: http://eureka7001:7001/eureka  #这个地址是 7001注册中心在 application.yml 中暴露出来额注册地址 （单机版）
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/  #将服务注册到 Eureka 集群
  instance:
    instance-id: spring-cloud-provider-8004 #自定义服务名称信息
    prefer-ip-address: true  #显示访问路径的 ip 地址
#####################spring cloud 使用 Spring Boot actuator 监控完善信息###########################################
# Spring Boot 2.50对 actuator 监控屏蔽了大多数的节点，只暴露了 heath 节点，本段配置（*）就是为了开启所有的节点
management:
  endpoints:
    web:
      exposure:
        include: &quot;*&quot;   # * 在yaml 文件属于关键字，所以需要加引号
info:
  app.name: micro-service-cloud-provider-dept-hystrix
  company.name: c.biancheng.net
  build.aetifactId: @project.artifactId@
  build.version: @project.version@</pre>
<br />
3. 在 net.biancheng.c.service 包下创建一个名为&nbsp;&nbsp;DeptService 的接口，代码如下。
<pre class="java">
package net.biancheng.c.service;

public interface DeptService {

    // hystrix 熔断器示例 ok
    public String deptInfo_Ok(Integer id);

    //hystrix 熔断器超时案例
    public String deptInfo_Timeout(Integer id);
}</pre>
<br />
4. 在 net.biancheng.c.service.impl 包下，创建&nbsp;DeptService 接口的实现类&nbsp;DeptServiceImpl，代码如下。
<pre class="java">
package net.biancheng.c.service.impl;

import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;
import net.biancheng.c.service.DeptService;
import org.springframework.stereotype.Service;

import java.util.concurrent.TimeUnit;

@Service(&quot;deptService&quot;)
public class DeptServiceImpl implements DeptService {

    @Override
    public String deptInfo_Ok(Integer id) {
        return &quot;线程池：&quot; + Thread.currentThread().getName() + &quot;  deptInfo_Ok,id:   &quot; + id;
    }

    //一旦该方法失败并抛出了异常信息后，会自动调用  @HystrixCommand 注解标注的 fallbackMethod 指定的方法
    @HystrixCommand(fallbackMethod = &quot;dept_TimeoutHandler&quot;,
            commandProperties =
                    //规定 5 秒钟以内就不报错，正常运行，超过 5 秒就报错，调用指定的方法
                    {@HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;5000&quot;)})
    @Override
    public String deptInfo_Timeout(Integer id) {
        int outTime = 6;
        try {
            TimeUnit.SECONDS.sleep(outTime);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return &quot;线程池：&quot; + Thread.currentThread().getName() + &quot;  deptInfo_Timeout,id:   &quot; + id + &quot;  耗时: &quot; + outTime;
    }

    // 当服务出现故障后，调用该方法给出友好提示
    public String dept_TimeoutHandler(Integer id) {
       return  &quot;C语言中文网提醒您，系统繁忙请稍后再试！&quot;+&quot;线程池：&quot; + Thread.currentThread().getName() + &quot;&nbsp; deptInfo_Timeout,id:&nbsp;&nbsp; &quot; + id;
    }
}</pre>
<br />
我们可以看到 deptInfo_Timeout() 方法上使用 @HystrixCommand 注解，该注解说明如下：
<ul>
<li>
参数 fallbackMethod 属性用于指定降级方法。</li>
<li>
参数 execution.isolation.thread.timeoutInMilliseconds 用于设置自身调用超时时间的峰值，峰值内可以正常运行，否则执行降级方法</li>
</ul>
<br />
5.&nbsp; 在 net.biancheng.c.controller 包下创建一个名为 DeptController 的 Controller 类，代码如下。
<pre class="java">
package net.biancheng.c.controller;

import lombok.extern.slf4j.Slf4j;
import net.biancheng.c.service.DeptService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;

@RestController
@Slf4j
public class DeptController {
    @Autowired
    private DeptService deptService;
    @Value(&quot;${server.port}&quot;)
    private String serverPort;

    @RequestMapping(value = &quot;/dept/hystrix/ok/{id}&quot;)
    public String deptInfo_Ok(@PathVariable(&quot;id&quot;) Integer id) {
        String result = deptService.deptInfo_Ok(id);
        log.info(&quot;端口号：&quot; + serverPort + &quot; result:&quot; + result);
        return result + &quot;，   端口号：&quot; + serverPort;
    }

    // Hystrix 服务超时降级
    @RequestMapping(value = &quot;/dept/hystrix/timeout/{id}&quot;)
    public String deptInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) {
        String result = deptService.deptInfo_Timeout(id);
        log.info(&quot;端口号：&quot; + serverPort + &quot; result:&quot; + result);
        return result + &quot;，   端口号：&quot; + serverPort;
    }

}</pre>
<br />
6. 在&nbsp;micro-service-cloud-provider-dept-hystrix-8004 的主启动类上，使用&nbsp;@EnableCircuitBreaker 注解开启熔断器功能，代码如下。
<pre class="java">
package net.biancheng.c;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableEurekaClient //开启 Eureka 客户端功能
@EnableCircuitBreaker //激活熔断器功能
public class MicroServiceCloudProviderDeptHystrix8004Application {

    public static void main(String[] args) {
        SpringApplication.run(MicroServiceCloudProviderDeptHystrix8004Application.class, args);
    }

}</pre>
<br />
7. 依次启动服务注册中心（Eureka Server）集群和&nbsp;micro-service-cloud-provider-dept-hystrix-8004，并使用浏览器访问&ldquo;http://eureka7001.com:8004/dept/hystrix/ok/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix ok" src="../uploads/allimg/211210/1016234615-1.png" /><br />
图2：Hystrix 正常服务案例</div>
<br />
8. 使用浏览器访问&ldquo;http://eureka7001.com:8004/dept/hystrix/timeout/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 服务降级" src="../uploads/allimg/211210/101623FR-2.png" /><br />
图3：Hystrix 服务端服务降级</div>
<h4>
客户端服务降级</h4>
通常情况下，我们都会在客户端进行服务降级，当客户端调用的服务端的服务不可用时，客户端直接进行服务降级处理，避免其线程被长时间、不必要地占用。<br />
<br />
客户端服务降级步骤如下。<br />
<br />
1. 在&nbsp;micro-service-cloud-consumer-dept-feign 的 pom.xml 中添加 Hystrix 的依赖，代码如下。
<pre class="xml">
&lt;!--hystrix 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
<br />
2.&nbsp;在 micro-service-cloud-consumer-dept-feign 的 application.yml 中添加以下配置，开启客户端的 Hystrix 功能。
<pre class="xml">
feign:
  hystrix:
    enabled: true #开启客户端 hystrix</pre>
<br />
3. 在&nbsp;net.biancheng.c.service 包下，创建一个名为&nbsp;DeptHystrixService 的服务绑定接口，与&nbsp;micro-service-cloud-provider-dept-hystrix-8004 中提供的服务接口进行绑定，代码如下。
<pre class="java">
package net.biancheng.c.service;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

@Component
@FeignClient(value = &quot;MICROSERVICECLOUDPROVIDERDEPTHYSTRIX&quot;)
public interface DeptHystrixService {
    @RequestMapping(value = &quot;/dept/hystrix/ok/{id}&quot;)
    public String deptInfo_Ok(@PathVariable(&quot;id&quot;) Integer id);

    @RequestMapping(value = &quot;/dept/hystrix/timeout/{id}&quot;)
    public String deptInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id);
}</pre>
<br />
4. 在&nbsp;net.biancheng.c.controller 包下创建一个名为&nbsp;HystrixController_Consumer 的 Controller ，代码如下。<br />
<pre class="java">
package net.biancheng.c.controller;

import com.netflix.hystrix.contrib.javanica.annotation.DefaultProperties;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;;
import lombok.extern.slf4j.Slf4j;
import net.biancheng.c.service.DeptHystrixService;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;

@Slf4j
@RestController
public class HystrixController_Consumer {

&nbsp;&nbsp;&nbsp; @Resource
&nbsp;&nbsp;&nbsp; private DeptHystrixService deptHystrixService;

&nbsp;&nbsp;&nbsp; @RequestMapping(value = &quot;/consumer/dept/hystrix/ok/{id}&quot;)
&nbsp;&nbsp;&nbsp; public String deptInfo_Ok(@PathVariable(&quot;id&quot;) Integer id) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return deptHystrixService.deptInfo_Ok(id);
&nbsp;&nbsp;&nbsp; }

&nbsp;&nbsp;&nbsp; //在客户端进行降级
&nbsp;&nbsp;&nbsp; @RequestMapping(value = &quot;/consumer/dept/hystrix/timeout/{id}&quot;)
&nbsp;&nbsp;&nbsp; @HystrixCommand(fallbackMethod = &quot;dept_TimeoutHandler&quot;) //为该请求指定专属的回退方法
&nbsp;&nbsp;&nbsp; public String deptInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String s = deptHystrixService.deptInfo_Timeout(id);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log.info(s);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return s;
&nbsp;&nbsp;&nbsp; }

&nbsp;&nbsp;&nbsp; // deptInfo_Timeout方法的 专用 fallback 方法
&nbsp;&nbsp;&nbsp; public String dept_TimeoutHandler(@PathVariable(&quot;id&quot;) Integer id) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log.info(&quot;deptInfo_Timeout 出错，服务已被降级！&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return &quot;C语言中文网提醒您：服务端系统繁忙，请稍后再试！（客户端 deptInfo_Timeout 专属的回退方法触发）&quot;;
&nbsp;&nbsp;&nbsp; }
}</pre>
<br />
5. 在配置文件 appliction.yml 中添加以下配置，在客户端配置请求超时的时间。<br />
<br />
<pre class="xml">
######################### Ribbon 客户端超时控制 ###################################
ribbon:
&nbsp; ReadTimeout: 6000 #建立连接所用的时间，适用于网络状况正常的情况下，两端两端连接所用的时间
&nbsp; ConnectionTimeout: 6000 #建立连接后，服务器读取到可用资源的时间
######################配置请求超时时间##########################
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 7000
####################配置具体方法超时时间 为 3 秒########################
    DeptHystrixService#deptInfo_Timeout(Integer):
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 3000</pre>
<br />
在配置文件中设计请求的超时时间时，需要注意以下 2 点：&nbsp;<br />
<br />
1）Hystrix 可以来为所有请求（方法）设置超时时间（单位为毫秒），若请求超时则触发全局的回退方法进行处理。
<pre class="info-box">
hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=mmm</pre>
<br />
2）Hystrix 还可以为某个特定的服务请求（方法）设置超时时间，格式如下：
<pre class="info-box">
hystrix.command.xxx#yyy(zzz).execution.isolation.thread.timeoutInMilliseconds=mmm</pre>
格式说明如下：
<ul>
<li>
xxx：为包含该服务方法的类的名称（通常为服务绑定接口的名称），例如&nbsp;DeptHystrixService 接口。</li>
<li>
yyy：服务方法名，例如 deptInfo_Timeout() 方法。</li>
<li>
zzz：方法内的参数类型，例如 Integer、String 等等</li>
<li>
mmm：要设置的超时时间，单位为毫秒（1 秒 =1000 毫秒）</li>
</ul>
<br />
6. 在&nbsp;micro-service-cloud-consumer-dept-feign 的主启动类上，使用 @EnableHystrix 注解开启客户端 Hystrix 功能，代码如下。<br />
<pre class="java">
package net.biancheng.c;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.hystrix.EnableHystrix;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableFeignClients //开启 OpenFeign 功能
@EnableHystrix //启用 Hystrix
public class MicroServiceCloudConsumerDeptFeignApplication {

    public static void main(String[] args) {
        SpringApplication.run(MicroServiceCloudConsumerDeptFeignApplication.class, args);
    }
}</pre>
<br />
7. 修改 micro-service-cloud-provider-dept-hystrix-8004 中 DeptServiceImpl 的代码，将 deptInfo_Timeout() 方法的运行时间修改为 4 秒（小于超时时间 5 秒），以保证服务端请求正常不被降级，代码如下。<br />
<pre class="java">
//一旦该方法失败并抛出了异常信息后，会自动调用  @HystrixCommand 注解标注的 fallbackMethod 指定的方法
@HystrixCommand(fallbackMethod = &quot;dept_TimeoutHandler&quot;,
        commandProperties =
                //规定 5 秒钟以内就不报错，正常运行，超过 5 秒就报错，调用指定的方法
                {@HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;5000&quot;)})
@Override
public String deptInfo_Timeout(Integer id) {
    int outTime = 4;
    try {
        TimeUnit.SECONDS.sleep(outTime);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return &quot;线程池：&quot; + Thread.currentThread().getName() + &quot;  deptInfo_Timeout,id:   &quot; + id + &quot;  耗时: &quot; + outTime;
}</pre>
<br />
8. 重启&nbsp;micro-service-cloud-provider-dept-hystrix-8004 和&nbsp;micro-service-cloud-consumer-dept-feign，使用浏览器访问&ldquo;http://eureka7001.com:8004/dept/hystrix/timeout/1&rdquo;，直接调用服务端的&nbsp;deptInfo_Timeout() 方法，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 服务端请求正常" src="../uploads/allimg/211210/1016231059-3.png" /><br />
图4：Hystrix 服务端请求正常</div>
<br />
9. 使用浏览器访问&ldquo;http://eureka7001.com/consumer/dept/hystrix/timeout/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 客户端服务降级" src="../uploads/allimg/211210/101623C94-4.png" /><br />
图5：Hystrix 客户端服务降级</div>
<br />
由图 5 可以看出，由于服务请求的耗时为 4 秒，超过了客户端为该请求指定的超时时间 （3 秒&nbsp;），因此该服务被降级处理，触发了其指定的回退方法。<br />
<h2>
全局降级方法</h2>
通过上面的方式实现服务降级时，需要针对所有业务方法都配置降级方法，这极有可能会造成代码的急剧膨胀。为了解决该问题，我们还可以为所有业务方法指定一个全局的回退方法，具体步骤如下。<br />
<br />
1. 在&nbsp;HystrixController_Consumer 的类名上标注 @DefaultProperties 注解，并通过其&nbsp;defaultFallback 属性指定一个全局的降级方法，代码如下。<br />
<pre class="java">
@Slf4j
@RestController
@DefaultProperties(defaultFallback = &quot;dept_Global_FallbackMethod&quot;) //全局的服务降级方法
public class HystrixController_Consumer {
&hellip;&hellip;
}</pre>
<br />
2. 在&nbsp;HystrixController_Consumer 中，创建一个名为&nbsp;dept_Global_FallbackMethod 的全局回方法，代码如下。
<pre class="java">
/**
 * 全局的 fallback 方法，
 * 回退方法必须和 hystrix 的执行方法在相同类中
 * @DefaultProperties(defaultFallback = &quot;dept_Global_FallbackMethod&quot;) 类上注解，请求方法上使用 @HystrixCommand 注解
 */
public String dept_Global_FallbackMethod() {
    return &quot;C语言中文网提醒您，运行出错或服务端系统繁忙，请稍后再试！（客户端全局回退方法触发,）&quot;;
}</pre>
<blockquote>
<p>
<strong>注意</strong>：降级（FallBack）方法必须与其对应的业务方法在同一个类中，否则无法生效。</p>
</blockquote>
3. 在所有的业务方法上都标注 @HystrixCommand 注解，这里我们将&nbsp;deptInfo_Timeout() 方法上的 @HystrixCommand(fallbackMethod = &quot;dept_TimeoutHandler&quot;) 修改为&nbsp;@HystrixCommand 即可，代码如下。
<pre class="java">
//在客户端进行降级
@RequestMapping(value = &quot;/consumer/dept/hystrix/timeout/{id}&quot;)
@HystrixCommand
public String deptInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id) {
    String s = deptHystrixService.deptInfo_Timeout(id);
    log.info(s);
    return s;
}</pre>
<blockquote>
<p>
<strong>注意</strong>：全局降级方法的优先级较低，只有业务方法没有指定其降级方法时，服务降级时才会触发全局回退方法。若业务方法指定它自己的回退方法，那么在服务降级时，就只会直接触发它自己的回退方法，而非全局回退方法。</p>
</blockquote>
4. 重启&nbsp;micro-service-cloud-consumer-dept-feign，使用浏览器访问&ldquo;http://eureka7001.com/consumer/dept/hystrix/timeout/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 全局回退方法" src="../uploads/allimg/211210/101623J11-5.png" /><br />
图6：全局回退方法</div>
<h2>
解耦降级逻辑</h2>
不管是业务方法指定的降级方法还是全局降级方法，它们都必须和业务方法在同一个类中才能生效，业务逻辑与降级逻辑耦合度极高。<br />
<br />
下面我们对业务逻辑与降级逻辑进行解耦，操作步骤如下。<br />
<br />
1. 在&nbsp;micro-service-cloud-consumer-dept-feign 的 net.biancheng.c.service 包下，新建 DeptHystrixService 接口的实现类&nbsp;DeptHystrixFallBackService，统一为&nbsp;DeptHystrixService 中的方法提供服务降级处理 ，代码如下。
<pre class="java">
package net.biancheng.c.service;

import org.springframework.stereotype.Component;

/**
* Hystrix 服务降级
* 解耦回退逻辑
*/
@Component
public class DeptHystrixFallBackService implements DeptHystrixService {
    @Override
    public String deptInfo_Ok(Integer id) {
        return &quot;--------------------C语言中文网提醒您，系统繁忙，请稍后重试！（解耦回退方法触发）-----------------------&quot;;
    }

    @Override
    public String deptInfo_Timeout(Integer id) {
        return &quot;--------------------C语言中文网提醒您，系统繁忙，请稍后重试！（解耦回退方法触发）-----------------------&quot;;
    }
}</pre>
<blockquote>
<p>
<strong>注意</strong>：该类必须以组件的形式添加 Spring 容器中才能生效，最常用的方式就是在类上标注 @Component 注解。</p>
</blockquote>
2. 在服务绑定接口&nbsp;DeptHystrixService 标注的&nbsp;@FeignClient 注解中添加 fallback 属性，属性值为&nbsp;DeptHystrixFallBackService.class，代码如下。
<pre class="java">
package net.biancheng.c.service;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

@Component
@FeignClient(value = &quot;MICROSERVICECLOUDPROVIDERDEPTHYSTRIX&quot;, fallback = DeptHystrixFallBackService.class)
public interface DeptHystrixService {
    @RequestMapping(value = &quot;/dept/hystrix/ok/{id}&quot;)
    public String deptInfo_Ok(@PathVariable(&quot;id&quot;) Integer id);

    @RequestMapping(value = &quot;/dept/hystrix/timeout/{id}&quot;)
    public String deptInfo_Timeout(@PathVariable(&quot;id&quot;) Integer id);
}</pre>
<br />
3. 重启&nbsp;micro-service-cloud-consumer-dept-feign，然后关闭服务端 micro-service-cloud-provider-dept-hystrix-8004，使用浏览器访问&ldquo;http://eureka7001.com/consumer/dept/hystrix/ok/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 解耦回退逻辑" src="../uploads/allimg/211210/1016233063-6.png" /><br />
图7：Hystrix 解耦回退方法</div>
<h2>
Hystrix 服务熔断</h2>
熔断机制是为了应对雪崩效应而出现的一种微服务链路保护机制。<br />
<br />
当微服务系统中的某个微服务不可用或响应时间太长时，为了保护系统的整体可用性，熔断器会暂时切断请求对该服务的调用，并快速返回一个友好的错误响应。这种熔断状态不是永久的，在经历了一定的时间后，熔断器会再次检测该微服务是否恢复正常，若服务恢复正常则恢复其调用链路。
<h4>
熔断状态</h4>
在熔断机制中涉及了三种熔断状态：<br />
<ul>
<li>
熔断关闭状态（Closed）：当服务访问正常时，熔断器处于关闭状态，服务调用方可以正常地对服务进行调用。</li>
<li>
熔断开启状态（Open）：默认情况下，在固定时间内接口调用出错比率达到一个阈值（例如&nbsp;50%），熔断器会进入熔断开启状态。进入熔断状态后，后续对该服务的调用都会被切断，熔断器会执行本地的降级（FallBack）方法。</li>
<li>
半熔断状态（Half-Open）：&nbsp;在熔断开启一段时间之后，熔断器会进入半熔断状态。在半熔断状态下，熔断器会尝试恢复服务调用方对服务的调用，允许部分请求调用该服务，并监控其调用成功率。如果成功率达到预期，则说明服务已恢复正常，熔断器进入关闭状态；如果成功率仍旧很低，则重新进入熔断开启状态。</li>
</ul>
<br />
三种熔断状态之间的转化关系如下图：<br />
<br />
<div style="text-align: center;">
<img alt="熔断状态转换" src="../uploads/allimg/211210/10162355X-7.png" /><br />
图8：三种熔断状态转换</div>
<h4>
Hystrix 实现熔断机制</h4>
在 Spring Cloud 中，熔断机制是通过 Hystrix 实现的。Hystrix 会监控微服务间调用的状况，当失败调用到一定比例时（例如 5 秒内失败 20 次），就会启动熔断机制。<br />
<br />
Hystrix 实现服务熔断的步骤如下：<br />
<ol>
<li>
当服务的调用出错率达到或超过 Hystix 规定的比率（默认为 50%）后，熔断器进入熔断开启状态。</li>
<li>
熔断器进入熔断开启状态后，Hystrix 会启动一个休眠时间窗，在这个时间窗内，该服务的降级逻辑会临时充当业务主逻辑，而原来的业务主逻辑不可用。</li>
<li>
当有请求再次调用该服务时，会直接调用降级逻辑快速地返回失败响应，以避免系统雪崩。</li>
<li>
当休眠时间窗到期后，Hystrix 会进入半熔断转态，允许部分请求对服务原来的主业务逻辑进行调用，并监控其调用成功率。</li>
<li>
如果调用成功率达到预期，则说明服务已恢复正常，Hystrix 进入熔断关闭状态，服务原来的主业务逻辑恢复；否则 Hystrix 重新进入熔断开启状态，休眠时间窗口重新计时，继续重复第 2 到第 5 步。</li>
</ol>
<h4>
示例</h4>
下面我们就通过一个实例来验证下 Hystrix 是如何实现熔断机制的。<br />
<br />
1. 在&nbsp;micro-service-cloud-provider-dept-hystrix-8004 中的&nbsp;DeptService 接口中添加一个&nbsp;deptCircuitBreaker() 方法，代码如下。
<pre class="java">
package net.biancheng.c.service;

public interface DeptService {

    // hystrix 熔断器示例 ok
    public String deptInfo_Ok(Integer id);
   
    //hystrix 熔断器超时案例
    public String deptInfo_Timeout(Integer id);

    // Hystrix 熔断机制案例
    public String deptCircuitBreaker(Integer id);
}</pre>
<br />
2. 在 DeptService 接口的实现类&nbsp;DeptServiceImpl 添加&nbsp;deptCircuitBreaker() 的方法实现及其回退方法，代码如下。
<pre class="java">
//Hystrix 熔断案例
@Override
@HystrixCommand(fallbackMethod = &quot;deptCircuitBreaker_fallback&quot;, commandProperties = {
        //以下参数在 HystrixCommandProperties 类中有默认配置
        @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;, value = &quot;true&quot;), //是否开启熔断器
&nbsp;&nbsp;&nbsp;&nbsp;@HystrixProperty(name = &quot;metrics.rollingStats.timeInMilliseconds&quot;,value = &quot;1000&quot;), //统计时间窗
        @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;, value = &quot;10&quot;), //统计时间窗内请求次数
        @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;, value = &quot;10000&quot;), //休眠时间窗口期
        @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;, value = &quot;60&quot;), //在统计时间窗口期以内，请求失败率达到 60% 时进入熔断状态
})
public String deptCircuitBreaker(Integer id) {
    if (id &lt; 0) {
        //当传入的 id 为负数时，抛出异常，调用降级方法
        throw new RuntimeException(&quot;c语言中文网提醒您，id 不能是负数！&quot;);
    }
    String serialNum = IdUtil.simpleUUID();
    return Thread.currentThread().getName() + &quot;\t&quot; + &quot;调用成功，流水号为：&quot; + serialNum;
}

//deptCircuitBreaker 的降级方法
public String deptCircuitBreaker_fallback(Integer id) {
    return &quot;c语言中文网提醒您，id 不能是负数,请稍后重试!\t id:&quot; + id;
}</pre>
<br />
在以上代码中，共涉及到了 4 个与 Hystrix 熔断机制相关的重要参数，这 4 个参数的含义如下表。<br />
<br />
<table>
<tbody>
<tr>
<th>
参数</th>
<th>
描述</th>
</tr>
<tr>
<td>
metrics.rollingStats.timeInMilliseconds</td>
<td>
统计时间窗。</td>
</tr>
<tr>
<td>
circuitBreaker.sleepWindowInMilliseconds</td>
<td>
休眠时间窗，熔断开启状态持续一段时间后，熔断器会自动进入半熔断状态，这段时间就被称为休眠窗口期。</td>
</tr>
<tr>
<td>
circuitBreaker.requestVolumeThreshold</td>
<td>
请求总数阀值。<br />
<br />
在统计时间窗内，请求总数必须到达一定的数量级，Hystrix 才可能会将熔断器打开进入熔断开启转态，而这个请求数量级就是 请求总数阀值。Hystrix 请求总数阈值默认为 20，这就意味着在统计时间窗内，如果服务调用次数不足 20 次，即使所有的请求都调用出错，熔断器也不会打开。</td>
</tr>
<tr>
<td>
circuitBreaker.errorThresholdPercentage</td>
<td>
错误百分比阈值。<br />
<br />
当请求总数在统计时间窗内超过了请求总数阀值，且请求调用出错率超过一定的比例，熔断器才会打开进入熔断开启转态，而这个比例就是错误百分比阈值。错误百分比阈值设置为 50，就表示错误百分比为 50%，如果服务发生了 30 次调用，其中有 15 次发生了错误，即超过了 50% 的错误百分比，这时候将熔断器就会打开。</td>
</tr>
</tbody>
</table>
<br />
3. 在&nbsp;DeptController 中添加一个 deptCircuitBreaker() 方法对外提供服务，代码如下。
<pre class="java">
// Hystrix 服务熔断
@RequestMapping(value = &quot;/dept/hystrix/circuit/{id}&quot;)
public String deptCircuitBreaker(@PathVariable(&quot;id&quot;) Integer id){
    String result = deptService.deptCircuitBreaker(id);
    log.info(&quot;result:&quot;+result);
    return result;
}</pre>
<br />
4. 重启&nbsp;micro-service-cloud-provider-dept-hystrix-8004，使用浏览器访问&ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/1&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 实现熔断机制 调用正确" src="../uploads/allimg/211210/1016233Q8-8.png" /><br />
图9：Hystrix 实现熔断机制 调用正确示例</div>
<br />
5. 浏览器多次（调用次数大于请求总数阀值）访问&ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/-2&rdquo;，使调用出错率大于错误百分比阀值，结果下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 实现熔断机制 错误调用" src="../uploads/allimg/211210/10162332D-9.png" /><br />
图10：Hystrix 实现熔断机制 错误调用</div>
<br />
6. 重新将参数修改为正数（例如参数为 3），使用浏览器访问&ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/3&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 熔断开启转台" src="../uploads/allimg/211210/1016235592-10.png" /><br />
图11：Hystrix 熔断开启状态传入正数</div>
<br />
通过图 11 可以看到，在熔断开启状态下，即使我们传入的参数已经是正数，调用的依然降级逻辑。<br />
<br />
7. 继续连续访问&ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/3&rdquo;，结果下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 熔断关闭" src="../uploads/allimg/211210/1016231R0-11.gif" /><br />
图12：Hystrix 进入熔断关闭状态</div>
<br />
通过图 12 可以看出，当服务调用正确率上升到一定的利率后，Hystrix 进入熔断关闭状态。<br />
<h2>
Hystrix 故障监控</h2>
Hystrix 还提供了准实时的调用监控（Hystrix Dashboard）功能，Hystrix 会持续地记录所有通过 Hystrix 发起的请求的执行信息，并以统计报表的形式展示给用户，包括每秒执行请求的数量、成功请求的数量和失败请求的数量等。<br />
<br />
下面我们就通过一个实例来搭建 Hystrix Dashboard，监控 micro-service-cloud-provider-dept-hystrix-8004 的运行情况。<br />
<br />
1. 在父工程下新建一个名为&nbsp;micro-service-cloud-consumer-dept-hystrix-dashboard-9002 的子模块，并在其 pom.xml 中添加以下依赖。<br />
<pre class="xml">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;spring-cloud-demo2&lt;/artifactId&gt;
        &lt;groupId&gt;net.biancheng.c&lt;/groupId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;net.biancheng.c&lt;/groupId&gt;
    &lt;artifactId&gt;micro-service-cloud-consumer-dept-hystrix-dashboard-9002&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;micro-service-cloud-consumer-dept-hystrix-dashboard-9002&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--Spring Boot 测试依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!--hystrix-dashboard 监控的依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--添加 Spring Boot 的监控模块--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;</pre>
<br />
2. 在 micro-service-cloud-consumer-dept-hystrix-dashboard-9002 的 application.yml 中添加以下配置。
<pre class="xml">
server:
  port: 9002  #端口号

#http://eureka7001.com:9002/hystrix 熔断器监控页面
# localhost:8004//actuator/hystrix.stream 监控地址
hystrix:
  dashboard:
    proxy-stream-allow-list:
      - &quot;localhost&quot;</pre>
<br />
3. 在&nbsp;micro-service-cloud-consumer-dept-hystrix-dashboard-9002 的主启动类上添加&nbsp;@EnableHystrixDashboard 注解，开启 Hystrix 监控功能，代码如下。
<pre class="java">
package net.biancheng.c;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;

@SpringBootApplication
@EnableHystrixDashboard
public class MicroServiceCloudConsumerDeptHystrixDashboard9002Application {

    public static void main(String[] args) {
        SpringApplication.run(MicroServiceCloudConsumerDeptHystrixDashboard9002Application.class, args);
    }

}</pre>
<br />
4. 在 micro-service-cloud-provider-dept-hystrix-8004 的&nbsp;net.biancheng.c.config 包下，创建一个名为&nbsp;HystrixDashboardConfig 的配置类，代码如下。
<pre class="java">
package net.biancheng.c.config;

import com.netflix.hystrix.contrib.metrics.eventstream.HystrixMetricsStreamServlet;
import org.springframework.boot.web.servlet.ServletRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class HystrixDashboardConfig {
    /**
     *  Hystrix dashboard 监控界面必须配置
     * @return
     */
    @Bean
    public ServletRegistrationBean getServlet() {
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings(&quot;/actuator/hystrix.stream&quot;);//访问路径
        registrationBean.setName(&quot;hystrix.stream&quot;);
        return registrationBean;
    }

}</pre>
<br />
5. 启动 micro-service-cloud-consumer-dept-hystrix-dashboard-9002，使用浏览器访问&ldquo;http://eureka7001.com:9002/hystrix&rdquo;，结果如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 监控" src="../uploads/allimg/211210/1016234440-12.png" /><br />
图13：Hystrix 监控页面</div>
<br />
6. 重启&nbsp;micro-service-cloud-provider-dept-hystrix-8004，并将以下信息填到 Hystrix 监控页面中，如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 监控信息" src="../uploads/allimg/211210/1016232636-13.png" /><br />
图14：Hystrix 监控信息</div>
<br />
7. 点击下方的 Monitor Stream 按钮，跳转到 Hystrix 对&nbsp;micro-service-cloud-provider-dept-hystrix-8004 的监控页面，如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 监控 8004" src="../uploads/allimg/211210/1016231229-14.png" /><br />
图15：Hystrix 监控微服务运行情况</div>
<br />
8. 使用浏览器多次访问&ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/1&rdquo;和 &ldquo;http://eureka7001.com:8004/dept/hystrix/circuit/-1&rdquo;，查看 Hystrix 监控页面，如下图。<br />
<br />
<div style="text-align: center;">
<img alt="Hystrix 监控 8004 运行情况" src="../uploads/allimg/211210/10162345J-15.png" /><br />
图16：Hystrix 监控服务运行情况</div>
</div>
<div id="ggxc-weixin-arcbottom">
<p>关注公众号「<span class="col-green">站长严长生</span>」，在手机上阅读所有教程，随时随地都能学习。内含一款搜索神器，免费下载全网书籍和视频。</p>
<p style="margin-top:12px; text-align:center;">
<img src="../templets/new/images/material/qrcode_mp.png" alt="公众号二维码" width="160" /><br />
<span class="col-green">微信扫码关注公众号</span>
</p>
</div>
<div class="pre-next-page clearfix">&nbsp;</div>
<div id="nice-arcs" class="box-bottom">
<h4>推荐阅读</h4>
<ul class="clearfix">
<li><a href="../view/niz69i_4.html" title="一套完整的嵌入式开发学习路线（高薪就业版）" target="_blank">一套完整的嵌入式开发学习路线（高薪就业版）</a></li>
<li><a href="../view/tnnfqo_2.html" title="一套课程卖1万，TMD太贵了！" target="_blank">一套课程卖1万，TMD太贵了！</a></li>
<li><a href="../view/unnurw_2.html" title="跑了3000公里，见了一位大佬" target="_blank">跑了3000公里，见了一位大佬</a></li>
<li><a href="../view/705.html" title="操作系统是什么，操作系统概述" target="_blank">操作系统是什么，操作系统概述</a></li>
<li><a href="../view/2214.html" title="C++类的成员变量和成员函数详解" target="_blank">C++类的成员变量和成员函数详解</a></li>
<li><a href="../view/6587.html" title="Java Object类详解" target="_blank">Java Object类详解</a></li>
<li><a href="../view/8105.html" title="单链表反转详解（4种算法实现）" target="_blank">单链表反转详解（4种算法实现）</a></li>
<li><a href="../redis/benchmarks.html" title="Redis Benchmark性能测试" target="_blank">Redis Benchmark性能测试</a></li>
<li><a href="../ml_alg/kmeans-theory.html" title="K-means聚类算法原理解析" target="_blank">K-means聚类算法原理解析</a></li>
<li><a href="../c/strncat.html" title="C语言strncat()：连接（拼接）前n个字符" target="_blank">C语言strncat()：连接（拼接）前n个字符</a></li>
</ul>
</div>
</div>
</div>
</div>
<script type="text/javascript">
// 当前文章ID
window.arcIdRaw = 'a_' + 9495;
window.arcId = "6af2nuUaK7PWuxPiJ8cpRLTnWqENEYcNt0C28/JWBkXnHVd7AyxCFIRI53w";
window.typeidChain = "434";
</script>
<div id="footer" class="clearfix">
<div class="info left">
<p>精美而实用的网站，分享优质编程教程，帮助有志青年。千锤百炼，只为大作；精益求精，处处斟酌；这种教程，看一眼就倾心。</p>
<p>
<a href="../view/8066.html" target="_blank" rel="nofollow">关于网站</a> <span>|</span>
<a href="../view/8092_2.html" target="_blank" rel="nofollow">关于站长</a> <span>|</span>
<a href="../view/8097.html" target="_blank" rel="nofollow">如何完成一部教程</a> <span>|</span>
<a href="../view/9648.html" target="_blank" rel="nofollow">公众号</a> <span>|</span>
<a href="../view/8093.html" target="_blank" rel="nofollow">联系我们</a> <span>|</span>
<a href="../sitemap/sitemap_3.html" target="_blank" rel="nofollow">网站地图</a>
</p>
<p>Copyright ©2012-2022 biancheng.net, <a href="https://beian.miit.gov.cn" target="_blank" rel="nofollow" style="color:#666;">冀ICP备2022013920号</a>, <img height="13" src="../templets/new/images/gongan.png" alt="公安备案图标" /><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=13110202001352" target="_blank" rel="nofollow" style="color:#666;">冀公网安备13110202001352号</a>
</p>
</div>
<img id="logo_bottom" class="right" src="https://c.biancheng.net/templets/new/images/logo_bottom.gif" alt="底部Logo" />
<span id="return-top"><b>↑</b></span>
</div>
<div id="addweixin-widget">
<p>
<script type="text/javascript">
			/*var suffix = 'c';
			var thisMin = (new Date()).getMinutes();
			if(thisMin>=40){
				suffix = 'd';
			}else if(thisMin>=20){
				suffix = 'e';
			}else{
				suffix = 'c';
			}
			document.write('<img src="https://c.biancheng.net/templets/new/images/material/qrcode_wx_'%20+%20suffix%20+'.png?v=1.7.07" alt="微信交流群" width="120" /><br />');*/
		</script>
<img src="../templets/new/images/material/qrcode_mp_2.png" alt="微信交流群" width="120" />
<span>关注微信公众号，加入官方交流群。内含一款搜索神器，免费下载全网书籍和视频。</span>
</p>
<span id="close-addweixin-widget" class="iconfont iconfont-close"></span>
</div>
<script type="text/javascript">
window.siteId = 4;
window.cmsTemplets = "/templets/new";
window.cmsTempletsVer = "1.7.07";
window.prePageURL = "/springcloud/open-feign.html";
window.nextPageURL = "/springcloud/gateway.html";
</script>
<script src="../templets/new/script/jquery1.12.4.min.js"></script>
<script src="https://c.biancheng.net/templets/new/script/common.js"></script>
<span style="display: none;">
<script charset="UTF-8" id="LA_COLLECT" src="https://sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"KDf6QzBhogyQjall",ck:"KDf6QzBhogyQjall",autoTrack:true})</script>
</span>
</body>
</html>